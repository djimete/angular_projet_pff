<header class="bg-white shadow-md sticky top-0 z-10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
    <h1 class="text-3xl font-bold text-indigo-600">
      <a href="#" (click)="showListView()">WorkingExpress</a>
    </h1>
    <a href="#" class="text-gray-600 hover:text-indigo-600 transition duration-150">Mon Tableau de Bord</a>
  </div>
</header>

<main id="app-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

  <ng-container *ngIf="currentDemand.status === 'list'">
    <nav class="flex space-x-4 mb-8 justify-center border-b pb-4 overflow-x-auto whitespace-nowrap">
      <a href="#" class="px-6 py-2 rounded-full bg-gray-100 text-gray-700 font-medium hover:bg-pink-100 hover:text-pink-700 transition duration-300">üß∏ Garde d'Enfants</a>
      <a href="#" class="px-6 py-2 rounded-full bg-gray-100 text-gray-700 font-medium hover:bg-emerald-100 hover:text-emerald-700 transition duration-300">üßπ Travail Domestique</a>
      <a href="#" class="px-6 py-2 rounded-full tech-bg tech-color font-bold border-2 border-lime-500 shadow-lg transition duration-300">üíª R√©paration Tech</a>
    </nav>

    <section class="mb-10 text-center md:text-left">
      <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">R√©paration & Support <span class="tech-color">üíª</span></h2>
      <p class="text-xl text-gray-500">Trouvez des experts pour r√©parer votre t√©l√©phone, ordinateur ou √©lectronique √† domicile ou en atelier.</p>
    </section>

    <form id="filter-form" class="bg-white p-6 rounded-xl shadow-lg mb-8 border border-gray-100">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Affiner votre recherche</h3>
      <button type="submit" class="px-6 py-3 bg-lime-600 text-white font-bold rounded-lg shadow-md hover:bg-lime-700 transition duration-300">
        Appliquer les Filtres
      </button>
    </form>

    <section>
      <h3 id="results-count" class="text-2xl font-bold text-gray-800 mb-6">{{ providerData.length }} Techniciens trouv√©s</h3>
      <div id="providers-list" class="space-y-6">

        <div *ngFor="let provider of providerData"
             class="provider-card bg-white p-6 rounded-xl shadow-lg border-l-4 {{ provider.isUrgent ? 'border-lime-600' : 'border-gray-400' }} flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"
             [attr.data-id]="provider.id">

          <div class="flex items-center space-x-4 w-full md:w-auto">
            <img [src]="provider.image" [alt]="'Photo de ' + provider.name" class="w-16 h-16 rounded-full border-2 {{ provider.isUrgent ? 'border-lime-600' : 'border-gray-400' }}">
            <div>
              <span class="text-xl font-bold text-gray-900">{{ provider.name }}</span>
              <p class="text-gray-600">{{ provider.title }}</p>

              <div class="flex items-center mt-1">
                <span class="text-sm font-bold mr-1 text-gray-800">{{ provider.rating.toFixed(1) }}</span>
                <span [innerHTML]="renderRatingStars(provider.rating)"></span>
                <span class="text-sm text-gray-500 ml-2">({{ provider.reviews }} Avis)</span>
              </div>
            </div>
          </div>

          <div class="flex flex-col items-start md:items-end space-y-2">
            <div class="availability-status flex items-center font-semibold px-3 py-1 rounded-full {{ provider.isUrgent ? 'text-lime-700 bg-lime-100' : 'text-gray-700 bg-gray-100' }} text-sm">
              <ng-container *ngIf="provider.isUrgent">
                        <span class="relative flex h-2 w-2 mr-2">
                            <span class="animate-pulse-tech absolute inline-flex h-full w-full rounded-full pulse-tech opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-lime-600"></span>
                        </span>
              </ng-container>
              <ng-container *ngIf="!provider.isUrgent">
                <span class="w-2 h-2 mr-2 rounded-full bg-gray-500"></span>
              </ng-container>
              {{ provider.status }}
            </div>

            <p class="text-2xl font-bold tech-color">{{ provider.price }}</p>
            <button (click)="renderProviderDetails(provider.id)"
                    class="px-5 py-2 bg-lime-600 text-white font-semibold rounded-lg hover:bg-lime-700 transition duration-300">
              Contacter
            </button>
          </div>
        </div>
      </div>
    </section>
  </ng-container>

  <ng-container *ngIf="currentDemand.status === 'detail' && currentProvider">
    <div class="max-w-4xl mx-auto">
      <button (click)="showListView()" class="mb-6 flex items-center text-gray-600 hover:text-lime-600 font-medium transition duration-150">
        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
        Retour √† la liste des techniciens
      </button>

      <div class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-lime-600 mb-8">
        <div class="flex flex-col md:flex-row items-start md:items-center space-y-6 md:space-y-0 md:space-x-8">
          <img [src]="currentProvider.image" [alt]="'Photo de ' + currentProvider.name" class="w-24 h-24 rounded-full border-4 border-lime-600 flex-shrink-0">

          <div class="flex-grow">
            <h2 class="text-4xl font-extrabold text-gray-900 mb-1">{{ currentProvider.name }}</h2>
            <p class="text-xl text-gray-600">{{ currentProvider.title }}</p>

            <div class="flex items-center space-x-4 mt-3">
              <div class="flex items-center">
                <span class="text-lg font-bold mr-1 text-gray-800">{{ currentProvider.rating.toFixed(1) }}</span>
                <span [innerHTML]="renderRatingStars(currentProvider.rating)"></span>
                <span class="text-sm text-gray-500 ml-2">({{ currentProvider.reviews }} Avis)</span>
              </div>
              <div class="flex items-center text-gray-500">
                <span class="mr-1">üìç</span> {{ currentProvider.location }}
              </div>
            </div>
          </div>

          <div class="flex flex-col items-center md:items-end flex-shrink-0 space-y-3 w-full md:w-auto">
            <p class="text-3xl font-bold tech-color">{{ currentProvider.price }}</p>
            <div class="font-semibold px-4 py-2 rounded-full"
                 [ngClass]="currentProvider.isUrgent ? 'text-lime-700 bg-lime-100' : 'text-gray-700 bg-gray-100'">
              {{ currentProvider.status }}
            </div>
            <button (click)="renderBookingForm(currentProvider.id)" class="px-8 py-3 bg-lime-600 text-white font-semibold rounded-xl hover:bg-lime-700 transition duration-300 shadow-md">
              Contacter & Soumettre Demande
            </button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-2xl font-bold text-gray-800 mb-4">√Ä propos de {{ currentProvider.name }}</h3>
          <p class="text-gray-600 leading-relaxed whitespace-pre-line">{{ currentProvider.description }}</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h3 class="text-2xl font-bold text-gray-800 mb-4">Prestations Cl√©s</h3>
          <ul class="space-y-3">
            <li *ngFor="let service of currentProvider.services" class="flex items-start text-gray-700">
              <span class="tech-color mr-2 mt-0.5">‚úîÔ∏è</span>
              <span>{{ service }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="currentDemand.status === 'booking' && currentProvider">
    <div class="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-xl border-t-8 border-lime-600">
      <h2 class="text-3xl font-bold text-gray-900 mb-2">Soumettre une demande de r√©paration</h2>
      <p class="text-gray-600 mb-6">Vous r√©servez aupr√®s de
        <span class="font-semibold text-lime-700">{{ currentProvider.name }}</span>,
        {{ currentProvider.title }}.</p>

      <form (ngSubmit)="handleBookingSubmit()">
        <div class="mb-5">
          <label for="device_type" class="block text-sm font-medium text-gray-700 mb-2">Type d'appareil concern√©</label>
          <select id="device_type" name="deviceType" [(ngModel)]="bookingForm.deviceType" required
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-lime-500 focus:border-lime-500">
            <option value="" disabled selected>S√©lectionnez un type</option>
            <option value="smartphone">Smartphone</option>
            <option value="pc">Ordinateur / Mac</option>
            <option value="console">Console de Jeu</option>
            <option value="autre">Autre appareil √©lectronique</option>
          </select>
        </div>

        <div class="mb-5">
          <label for="problem_description" class="block text-sm font-medium text-gray-700 mb-2">Description d√©taill√©e du probl√®me <span class="text-red-500">*</span></label>
          <textarea id="problem_description" name="problemDescription" rows="5" [(ngModel)]="bookingForm.problemDescription" required
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-lime-500 focus:border-lime-500"
                    placeholder="D√©crivez le mod√®le, la marque et la panne (ex: √âcran cass√© sur iPhone 13, PC ne s'allume plus apr√®s mise √† jour)."></textarea>
        </div>

        <div class="flex justify-between items-center mt-8">
          <button type="button" (click)="renderProviderDetails(currentProvider.id)" class="px-6 py-3 text-gray-600 font-semibold rounded-xl hover:bg-gray-100 transition duration-300">
            Annuler et Retour
          </button>
          <button type="submit" [disabled]="!bookingForm.deviceType || !bookingForm.problemDescription"
                  class="px-8 py-3 bg-lime-600 text-white font-semibold rounded-xl hover:bg-lime-700 transition duration-300 shadow-lg">
            Soumettre la Demande
          </button>
        </div>
      </form>
    </div>
  </ng-container>

  <ng-container *ngIf="currentDemand.status === 'submitted' && currentProvider">
    <div class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-xl text-center border-t-8 border-indigo-500">
      <div class="text-6xl mb-4 text-indigo-500">üí¨</div>
      <h2 class="text-3xl font-bold text-gray-900 mb-2">Demande Soumise !</h2>
      <p class="text-gray-600 mb-6">
        Votre demande a √©t√© envoy√©e √† <span class="font-semibold">{{ currentProvider.name }}</span>.
        Il est en cours d'examen.
      </p>
      <p class="text-sm text-gray-400 mb-6">Simulation : La r√©ponse du prestataire arrive imm√©diatement...</p>

      <button (click)="simulateAcceptance()" class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-300 shadow-md">
        Voir la R√©ponse du Prestataire
      </button>
    </div>
  </ng-container>

  <ng-container *ngIf="currentDemand.status === 'accepted' && currentProvider">
    <div class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-xl text-center border-t-8 border-lime-600">
      <div class="text-6xl mb-4 text-lime-600">üéâ</div>
      <h2 class="text-3xl font-bold text-gray-900 mb-2">Demande Accept√©e !</h2>
      <p class="text-gray-600 mb-6">
        {{ currentProvider.name }} a examin√© votre demande de r√©paration et le devis est √©tabli.
        <br>Le montant √† r√©gler pour d√©marrer l'intervention est de :
        <span class="text-2xl font-extrabold text-lime-600">{{ currentDemand.amountDue! }} ‚Ç¨</span>.
      </p>
      <button (click)="renderPaymentForm(currentProvider.id)" class="px-8 py-3 bg-lime-600 text-white font-semibold rounded-xl hover:bg-lime-700 transition duration-300 shadow-md">
        Proc√©der au Paiement
      </button>
      <button (click)="showListView()" class="mt-4 block w-full text-gray-500 hover:text-gray-700">Annuler / Retourner √† la liste</button>
    </div>
  </ng-container>

  <ng-container *ngIf="currentDemand.status === 'payment' && currentProvider">
    <div class="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-xl border-t-8 border-lime-600">
      <h2 class="text-3xl font-bold text-gray-900 mb-2">Finaliser le Paiement</h2>
      <p class="text-gray-600 mb-6">Paiement requis pour la demande de {{ currentProvider.name }}.</p>

      <div class="flex justify-between items-center bg-lime-50 p-4 rounded-lg mb-6 border border-lime-200">
        <span class="text-xl font-medium text-gray-700">Montant √† r√©gler :</span>
        <span class="text-3xl font-extrabold text-lime-600">{{ currentDemand.amountDue! }} ‚Ç¨</span>
      </div>

      <form #paymentForm="ngForm" (ngSubmit)="handlePaymentSubmit(amountToPay.value)">

        <h3 class="text-xl font-bold text-gray-800 mb-4">S√©lectionnez votre m√©thode de paiement</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="payment-option border-2 border-gray-200 p-4 rounded-xl text-center hover:border-lime-500 cursor-pointer"
               [class.border-lime-500]="selectedPaymentMethod === 'wave'"
               (click)="selectPaymentMethod('wave')">
            <img src="https://placehold.co/40x40/004B8D/ffffff?text=WAVE" alt="Wave" class="mx-auto mb-2 rounded-full">
            <span class="font-semibold text-gray-700">Wave</span>
          </div>
          <div class="payment-option border-2 border-gray-200 p-4 rounded-xl text-center hover:border-lime-500 cursor-pointer"
               [class.border-lime-500]="selectedPaymentMethod === 'orange-money'"
               (click)="selectPaymentMethod('orange-money')">
            <img src="https://placehold.co/40x40/FF7900/ffffff?text=OM" alt="Orange Money" class="mx-auto mb-2 rounded-full">
            <span class="font-semibold text-gray-700">Orange Money</span>
          </div>
          <div class="payment-option border-2 border-gray-200 p-4 rounded-xl text-center hover:border-lime-500 cursor-pointer"
               [class.border-lime-500]="selectedPaymentMethod === 'card'"
               (click)="selectPaymentMethod('card')">
            <img src="https://placehold.co/40x40/000000/ffffff?text=CB" alt="Carte Bancaire" class="mx-auto mb-2 rounded-full">
            <span class="font-semibold text-gray-700">Carte Bancaire</span>
          </div>
        </div>

        <div [class.hidden]="!selectedPaymentMethod" class="bg-gray-50 p-6 rounded-lg border border-gray-200">

          <ng-container *ngIf="selectedPaymentMethod === 'wave' || selectedPaymentMethod === 'orange-money'">
            <h4 class="text-lg font-semibold mb-3">Informations {{ selectedPaymentMethod!.toUpperCase() }}</h4>
            <div class="mb-4">
              <label for="phone_number" class="block text-sm font-medium text-gray-700 mb-2">Num√©ro de t√©l√©phone <span class="text-red-500">*</span></label>
              <input type="tel" id="phone_number" name="phoneNumber" required
                     class="w-full p-3 border border-gray-300 rounded-lg focus:ring-lime-500 focus:border-lime-500"
                     placeholder="Ex: 77 123 45 67">
            </div>
          </ng-container>

          <ng-container *ngIf="selectedPaymentMethod === 'card'">
            <h4 class="text-lg font-semibold mb-3">Informations de Carte Bancaire</h4>
            <div class="mb-4">
              <label for="card_number" class="block text-sm font-medium text-gray-700 mb-2">Num√©ro de carte <span class="text-red-500">*</span></label>
              <input type="text" id="card_number" name="cardNumber" required
                     class="w-full p-3 border border-gray-300 rounded-lg focus:ring-lime-500 focus:border-lime-500"
                     placeholder="XXXX XXXX XXXX XXXX">
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div class="col-span-2">
                <label for="expiry_date" class="block text-sm font-medium text-gray-700 mb-2">Date d'expiration (MM/AA) <span class="text-red-500">*</span></label>
                <input type="text" id="expiry_date" name="expiryDate" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-lime-500 focus:border-lime-500"
                       placeholder="MM/AA">
              </div>
              <div class="col-span-1">
                <label for="cvv" class="block text-sm font-medium text-gray-700 mb-2">CVV <span class="text-red-500">*</span></label>
                <input type="text" id="cvv" name="cvv" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-lime-500 focus:border-lime-500"
                       placeholder="123">
              </div>
            </div>
          </ng-container>

        </div>

        <div class="mt-6 mb-8">
          <label for="amount_to_pay" class="block text-sm font-medium text-gray-700 mb-2">Montant √† saisir par vous-m√™me (Minimum {{ currentDemand.amountDue! }} ‚Ç¨)</label>
          <input type="number" #amountToPay="ngModel" name="amountToPay" required [min]="currentDemand.amountDue!" [ngModel]="currentDemand.amountDue!"
                 class="w-full p-3 border border-gray-300 rounded-lg text-2xl font-bold text-gray-800 focus:ring-lime-500 focus:border-lime-500"
                 placeholder="Saisissez le montant exact">
        </div>

        <div class="flex justify-end">
          <button type="submit" id="pay-button" [disabled]="!selectedPaymentMethod || paymentForm.invalid"
                  class="px-8 py-3 text-white font-semibold rounded-xl shadow-lg transition duration-300"
                  [class.bg-gray-400]="!selectedPaymentMethod || paymentForm.invalid"
                  [class.bg-lime-600]="selectedPaymentMethod && paymentForm.valid"
                  [class.hover:bg-lime-700]="selectedPaymentMethod && paymentForm.valid">
            Payer
          </button>
        </div>
      </form>
    </div>
  </ng-container>

  <ng-container *ngIf="currentDemand.status === 'paid' && currentProvider">
    <div class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-xl text-center border-t-8 border-lime-600">
      <div class="text-6xl mb-4 text-lime-600">‚úÖ</div>
      <h2 class="text-3xl font-bold text-gray-900 mb-2">Paiement R√©ussi !</h2>
      <p class="text-gray-600 mb-4">
        Votre paiement de <span class="text-2xl font-extrabold text-lime-600">{{ currentDemand.amountDue! }} ‚Ç¨</span> a √©t√© effectu√© avec succ√®s pour la demande aupr√®s de
        {{ currentProvider.name }}.
      </p>
      <p class="text-gray-600 mb-6">
        Le prestataire va maintenant commencer la r√©paration.
      </p>
      <button (click)="showListView()" class="px-8 py-3 bg-lime-600 text-white font-semibold rounded-xl hover:bg-lime-700 transition duration-300 shadow-md">
        Retourner √† la liste des techniciens
      </button>
    </div>
  </ng-container>

</main>

<footer class="bg-gray-800 text-white mt-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
    <p>&copy; 2025 Working Express. Tous droits r√©serv√©s.</p>
  </div>
</footer>
