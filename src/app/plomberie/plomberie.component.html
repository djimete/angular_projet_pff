<header class="bg-white shadow-md sticky top-0 z-10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
    <h1 class="text-3xl font-bold text-indigo-600"><a routerLink="/">WorkingExpress</a></h1>
    <div id="auth-status" class="text-sm text-gray-600">Chargement de l'utilisateur...</div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

  <section id="list-view">
    <section class="mb-10 text-center md:text-left">
      <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">
        Plomberie <span class="text-indigo-600">üõ†Ô∏è</span>
      </h2>
      <p class="text-xl text-gray-500">Trouvez un plombier qualifi√© disponible pr√®s de chez vous.</p>
    </section>

    <form id="filter-form" class="bg-white p-6 rounded-xl shadow-lg mb-8 border border-gray-100">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Affiner votre recherche</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input type="text" id="filter-location" placeholder="Ville ou code postal"
               class="p-3 border border-gray-300 rounded-lg">

        <select id="filter-service"
                class="p-3 border border-gray-300 rounded-lg appearance-none">
          <option value="all">Tous les services</option>
          <option value="fuite">Fuite d'eau urgente</option>
          <option value="installation">Installation robinetterie</option>
          <option value="debouchage">D√©bouchage canalisation</option>
        </select>

        <div class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg">
          <input type="checkbox" id="filter-urgent" class="w-4 h-4 text-indigo-600">
          <label for="filter-urgent" class="text-gray-700">Disponible maintenant</label>
        </div>

        <button type="submit" id="apply-filters-btn"
                class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg">
          Appliquer les filtres
        </button>
      </div>
    </form>

    <section>
      <h3 id="results-count" class="text-2xl font-bold text-gray-800 mb-6">
        3 Plombiers trouv√©s dans votre r√©gion
      </h3>

      <div id="plumbers-list" class="space-y-6">

        <div class="plumber-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500"
             data-id="1" data-service="fuite,installation,debouchage"
             data-availability="now" data-location="dakar/rufisque">

          <div class="md:flex md:justify-between md:items-center">
            <div class="flex items-center space-x-4">
              <a href="#" (click)="showPlumberDetails('1'); $event.preventDefault()">
                <img src="https://placehold.co/80x80/059669/ffffff?text=L1"
                     class="w-16 h-16 rounded-full border-2 border-green-500">
              </a>

              <div>
                <a href="#" (click)="showPlumberDetails('1'); $event.preventDefault()"
                   class="text-xl font-bold text-gray-900 hover:text-indigo-600">
                  Louis M.
                </a>
                <p class="text-gray-600">Expert en d√©tection de fuites | 12 ans d'exp√©rience</p>
              </div>
            </div>

            <div class="flex flex-col items-start md:items-end space-y-2 mt-4 md:mt-0">
              <div class="availability-status text-green-700 bg-green-100 px-3 py-1 rounded-full">
                Disponible Maintenant
              </div>

              <p class="text-2xl font-bold text-indigo-600">10 000 XOF / heure</p>

              <a href="#" (click)="showPlumberDetails('1'); $event.preventDefault()"
                 class="px-5 py-2 bg-indigo-600 text-white rounded-lg">
                R√©servation
              </a>
            </div>
          </div>
        </div>

        <div class="plumber-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-orange-500"
             data-id="2" data-service="debouchage,installation" data-availability="soon">

          <div class="md:flex md:justify-between md:items-center">
            <div class="flex items-center space-x-4">
              <a href="#" (click)="showPlumberDetails('2'); $event.preventDefault()">
                <img src="https://placehold.co/80x80/f97316/ffffff?text=M2"
                     class="w-16 h-16 rounded-full border-2 border-orange-500">
              </a>

              <div>
                <a href="#" (click)="showPlumberDetails('2'); $event.preventDefault()"
                   class="text-xl font-bold hover:text-indigo-600">
                  Marion T.
                </a>
                <p class="text-gray-600">Plombi√®re certifi√©e RGE | 5 ans d'exp√©rience</p>
              </div>
            </div>

            <div class="flex flex-col items-start md:items-end space-y-2 mt-4 md:mt-0">
              <div class="availability-status text-orange-700 bg-orange-100 px-3 py-1 rounded-full">
                Prochain cr√©neau : Demain 8h00
              </div>
              <p class="text-2xl font-bold text-indigo-600">15 000 XOF / forfait</p>

              <a href="#" (click)="showPlumberDetails('2'); $event.preventDefault()"
                 class="px-5 py-2 bg-indigo-600 text-white rounded-lg">
                R√©servation
              </a>
            </div>
          </div>
        </div>

        <div class="plumber-card bg-white p-6 rounded-xl shadow-lg border-l-4 border-gray-400"
             data-id="3" data-service="installation" data-availability="booking">

          <div class="md:flex md:justify-between md:items-center">
            <div class="flex items-center space-x-4">
              <a href="#" (click)="showPlumberDetails('3'); $event.preventDefault()">
                <img src="https://placehold.co/80x80/9ca3af/ffffff?text=J3"
                     class="w-16 h-16 rounded-full border-2 border-gray-400">
              </a>

              <div>
                <a href="#" (click)="showPlumberDetails('3'); $event.preventDefault()"
                   class="text-xl font-bold hover:text-indigo-600">
                  Modou Diaw
                </a>
                <p class="text-gray-600">R√©paration de robinet | 2 ans d'exp√©rience</p>
              </div>
            </div>

            <div class="flex flex-col items-start md:items-end space-y-2 mt-4 md:mt-0">
              <div class="availability-status text-gray-700 bg-gray-100 px-3 py-1 rounded-full">
                Sur r√©servation (3 jours)
              </div>
              <p class="text-2xl font-bold text-indigo-600">Prix sur devis</p>

              <a href="#" (click)="showPlumberDetails('3'); $event.preventDefault()"
                 class="px-5 py-2 bg-indigo-600 text-white rounded-lg">
                R√©servation
              </a>
            </div>
          </div>
        </div>

      </div>

      <div id="no-results"
           class="hidden text-center p-8 bg-yellow-50 rounded-lg border border-yellow-200 mt-6">
        <p class="text-xl text-yellow-800 font-semibold">
          Aucun plombier ne correspond √† vos crit√®res.
        </p>
      </div>
    </section>
  </section>

  <section id="detail-view" class="hidden">
    <button (click)="showListView()"
            class="mb-6 inline-flex items-center text-indigo-600 hover:text-indigo-800">
      Retour √† la liste
    </button>

    <div id="plumber-details-container"
         class="bg-white p-8 rounded-xl shadow-2xl border border-gray-100">

      <div *ngIf="plombierSelectionne" class="flex flex-col md:flex-row items-start md:items-center space-y-6 md:space-y-0 md:space-x-8">

        <div class="flex-shrink-0">
          <div class="w-32 h-32 bg-green-600 rounded-full flex items-center justify-center text-5xl font-bold text-white">
            {{plombierSelectionne.initiales}}
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mt-4">{{plombierSelectionne.nom}}</h2>
          <p class="text-green-600 font-semibold">{{plombierSelectionne.specialite}}</p>
        </div>

        <div class="flex-grow">
          <div class="flex items-center space-x-2 text-gray-500 mb-2">
            <span class="text-red-500">üìç</span>
            <p>{{plombierSelectionne.zone}}</p>
          </div>

          <div class="flex items-center space-x-2 text-gray-800 mb-2">
            <span class="text-yellow-400 text-xl">‚≠êÔ∏è</span>
            <p class="font-bold">{{plombierSelectionne.note}} <span class="text-sm font-normal">({{plombierSelectionne.avisCount}} Avis)</span></p>
          </div>

          <p class="text-4xl font-extrabold text-indigo-600 mb-4">
            {{plombierSelectionne.tarif}}
          </p>

          <p class="text-gray-700 mb-4">
            {{plombierSelectionne.description}} <br>
            <span class="italic text-sm text-gray-500">Devis gratuit sur demande.</span>
          </p>

          <h3 class="text-lg font-bold text-gray-800 mb-2">Services Sp√©cialis√©s</h3>
          <div class="flex flex-wrap gap-2 mb-6">
            <span *ngFor="let service of plombierSelectionne.services"
                  class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
              {{service}}
            </span>
          </div>

          <ng-container *ngIf="reservationStatus === 'accepted'">
            <div class="bg-green-50 p-4 rounded-lg border border-green-300 mb-4">
              <p class="text-green-700 font-semibold flex items-center space-x-2 mb-2">
                <span class="text-2xl">‚úÖ</span>
                <span>R√©servation Accept√©e !</span>
              </p>
              <p class="text-gray-900 mb-3 font-bold">
                Votre code de validation pour le paiement et l'arriv√©e du prestataire est:
                <span class="text-green-700 text-xl">{{validationCode}}</span>
              </p>
              <p class="text-sm text-gray-600 italic">
                Veuillez effectuer le paiement de l'acompte (montant libre) pour confirmer la venue.
              </p>
            </div>

            <button (click)="openPaymentModal()"
                    class="w-full px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition">
              Payer l'acompte
            </button>
          </ng-container>

          <ng-container *ngIf="reservationStatus === 'initial'">
            <div class="flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
              <ng-container *ngIf="plombierSelectionne.disponible; else nonDisponible">
                <div class="bg-green-100 text-green-700 font-semibold px-4 py-2 rounded-full flex items-center space-x-2">
                  <span class="w-3 h-3 bg-green-500 rounded-full block"></span>
                  <span>Disponible Maintenant</span>
                </div>
              </ng-container>
              <ng-template #nonDisponible>
                <div class="bg-orange-100 text-orange-700 font-semibold px-4 py-2 rounded-full">
                  Sur r√©servation
                </div>
              </ng-template>

              <button (click)="openReservationModal()"
                      class="px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition">
                R√©server ce Plombier Maintenant
              </button>
            </div>
          </ng-container>

        </div>
      </div>
    </div>
  </section>

</main>

<div id="reservation-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <h2 class="text-2xl font-bold text-indigo-600 mb-6">Finaliser la R√©servation</h2>

    <form id="reservation-form" (submit)="submitReservation($event)">

      <div class="mb-4">
        <label for="reservation-nom" class="block text-gray-700 font-medium mb-1">Votre Nom Complet</label>
        <input type="text" id="reservation-nom" name="nom" placeholder="Ex: Aliou Diallo"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
      </div>

      <div class="mb-4">
        <label for="reservation-telephone" class="block text-gray-700 font-medium mb-1">Num√©ro de T√©l√©phone (pour contact)</label>
        <input type="tel" id="reservation-telephone" name="telephone" placeholder="Ex: 77 123 45 67"
               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
      </div>

      <div class="mb-6">
        <label for="reservation-description" class="block text-gray-700 font-medium mb-1">Description du Probl√®me</label>
        <textarea id="reservation-description" name="description" rows="4"
                  placeholder="D√©crivez bri√®vement la fuite, le d√©bouchage, etc."
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
      </div>

      <div class="flex justify-end space-x-3 mt-6">
        <button type="button" (click)="closeReservationModal()"
                class="px-5 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
          Annuler
        </button>
        <button type="submit"
                class="px-5 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
          Envoyer la demande de R√©servation
        </button>
      </div>
    </form>
  </div>
</div>

<div id="payment-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <h2 id="payment-title" class="text-2xl font-bold text-indigo-600 mb-4">Payer Acompte pour {{plombierSelectionne?.nom}}</h2>

    <form id="payment-form" (submit)="submitPayment($event)">

      <div class="mb-4">
        <label for="payment-method" class="block text-gray-700 font-medium mb-1">M√©thode de Paiement</label>
        <select id="payment-method" name="method"
                (change)="onPaymentMethodChange($event)"
                class="w-full p-3 border border-gray-300 rounded-lg appearance-none bg-white focus:ring-indigo-500 focus:border-indigo-500" required>
          <option value="">S√©lectionner une m√©thode</option>
          <option value="orange_money">Orange Money (Simul√©)</option>
          <option value="wave">Wave (Simul√©)</option>
          <option value="carte">Carte Bancaire (Simul√©)</option>
        </select>
      </div>

      <div *ngIf="!selectedPaymentMethod" class="text-center p-4 bg-gray-50 text-gray-600 rounded-lg mb-6">
        Veuillez choisir une m√©thode de paiement ci-dessus pour continuer.
      </div>


      <ng-container *ngIf="selectedPaymentMethod === 'orange_money'">
        <div class="bg-blue-100 p-3 rounded-lg border border-blue-300 text-blue-800 mb-4">
          <h4 class="font-semibold">Simulateur de Paiement ORANGE MONEY</h4>
          <p class="text-sm">Entrez votre num√©ro et le code de validation (affich√© lors de l'acceptation) pour la v√©rification simul√©e.</p>
        </div>

        <div class="mb-4">
          <label for="acompte-montant" class="block text-gray-700 font-medium mb-1">Montant √† Payer (XOF)</label>
          <input type="number" id="acompte-montant-om" name="montant" placeholder="Minimum 100 XOF"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required min="100">
        </div>

        <div class="mb-4">
          <label for="om-telephone" class="block text-gray-700 font-medium mb-1">Num√©ro de T√©l√©phone ORANGE MONEY</label>
          <input type="tel" id="om-telephone" name="telephone" placeholder="7x xxx xx xx"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
        </div>

        <div class="mb-6">
          <label for="om-code" class="block text-gray-700 font-medium mb-1">Code de Validation (Affich√© lors de l'acceptation)</label>
          <input type="text" id="om-code" name="om-code" placeholder="Entrez votre code √† 4 chiffres"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required maxlength="4">
        </div>
      </ng-container>


      <ng-container *ngIf="selectedPaymentMethod === 'wave'">
        <div class="bg-blue-100 p-3 rounded-lg border border-blue-300 text-blue-800 mb-4">
          <h4 class="font-semibold">Simulateur de Paiement WAVE</h4>
          <p class="text-sm">Entrez votre num√©ro et le code de validation (affich√© lors de l'acceptation) pour la v√©rification simul√©e.</p>
        </div>

        <div class="mb-4">
          <label for="acompte-montant" class="block text-gray-700 font-medium mb-1">Montant √† Payer (XOF)</label>
          <input type="number" id="acompte-montant-wave" name="montant" placeholder="Minimum 100 XOF"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required min="100">
        </div>

        <div class="mb-4">
          <label for="wave-telephone" class="block text-gray-700 font-medium mb-1">Num√©ro de T√©l√©phone WAVE</label>
          <input type="tel" id="wave-telephone" name="telephone" placeholder="7x xxx xx xx"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
        </div>

        <div class="mb-6">
          <label for="wave-code" class="block text-gray-700 font-medium mb-1">Code de Validation (Affich√© lors de l'acceptation)</label>
          <input type="text" id="wave-code" name="wave-code" placeholder="Entrez votre code √† 4 chiffres"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required maxlength="4">
        </div>
      </ng-container>


      <ng-container *ngIf="selectedPaymentMethod === 'carte'">
        <div class="bg-blue-100 p-3 rounded-lg border border-blue-300 text-blue-800 mb-4">
          <h4 class="font-semibold">Simulateur de Paiement par Carte Bancaire</h4>
          <p class="text-sm">Utilisez n'importe quelle valeur pour les champs de carte, puis entrez le code de validation (affich√© lors de l'acceptation) pour simuler la confirmation 3D Secure.</p>
        </div>

        <div class="mb-4">
          <label for="acompte-montant" class="block text-gray-700 font-medium mb-1">Montant √† Payer (XOF)</label>
          <input type="number" id="acompte-montant-carte" name="montant" placeholder="Minimum 100 XOF"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required min="100">
        </div>

        <div class="mb-4">
          <label for="card-number" class="block text-gray-700 font-medium mb-1">Num√©ro de Carte</label>
          <input type="text" id="card-number" name="cardNumber" placeholder="xxxx xxxx xxxx xxxx"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
        </div>

        <div class="mb-4">
          <label for="card-holder" class="block text-gray-700 font-medium mb-1">Nom du Titulaire</label>
          <input type="text" id="card-holder" name="cardHolder" placeholder="Pr√©nom Nom"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6">
          <div>
            <label for="card-expiry" class="block text-gray-700 font-medium mb-1">Date d'Expiration (MM/AA)</label>
            <input type="text" id="card-expiry" name="cardExpiry" placeholder="MM/AA"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required maxlength="5">
          </div>
          <div>
            <label for="card-cvv" class="block text-gray-700 font-medium mb-1">CVV</label>
            <input type="text" id="card-cvv" name="cardCvv" placeholder="123"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required maxlength="3">
          </div>
        </div>

        <div class="mb-6">
          <label for="card-3d-code" class="block text-gray-700 font-medium mb-1">Code de Validation (Simulation 3D Secure)</label>
          <input type="text" id="card-3d-code" name="card-3d-code" placeholder="Entrez votre code √† 4 chiffres"
                 class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required maxlength="4">
        </div>
      </ng-container>

      <div *ngIf="paymentErrorMessage" class="text-red-600 bg-red-50 p-3 rounded-lg border border-red-300 mb-4 font-semibold">
        {{paymentErrorMessage}}
      </div>

      <div *ngIf="selectedPaymentMethod" class="mt-6 flex justify-end space-x-3">
        <button type="button" (click)="closePaymentModal()"
                class="px-5 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
          Annuler
        </button>
        <button type="submit"
                class="px-5 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition">
          Confirmer et Payer
        </button>
      </div>

      <div *ngIf="!selectedPaymentMethod" class="mt-6 flex justify-end">
        <button type="button" (click)="closePaymentModal()"
                class="px-5 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
          Annuler
        </button>
      </div>
    </form>
  </div>
</div>

<div id="message-modal" class="modal-overlay hidden message-modal">
  <div class="modal-content">
    <div id="message-content"></div>

    <button (click)="closeMessageModal()"
            class="mt-4 px-5 py-2 bg-indigo-600 text-white rounded-lg">
      OK
    </button>
  </div>
</div>
