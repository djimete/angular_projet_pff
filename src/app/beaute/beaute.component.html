<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

  <section *ngIf="appState.step === 'list'">

    <section class="mb-10 text-center md:text-left">
      <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">
        Beauté & Bien-être à Domicile ✨
      </h2>
      <p class="text-xl text-gray-500">Trouvez et réservez votre professionnel(le) qualifié(e).</p>
    </section>

    <h3 class="text-2xl font-bold text-gray-800 mb-6">
      {{ providers.length }} Prestataire(s) trouvé(s)
    </h3>

    <div class="space-y-6">
      <div *ngFor="let provider of providers"
           class="provider-card bg-white p-6 rounded-xl shadow-lg border-l-4 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0"
           [ngClass]="{
              'border-pink-500': provider.status === 'Disponible',
              'border-gray-300': provider.status !== 'Disponible'
            }">

        <div class="flex items-center space-x-4 w-full md:w-auto">
          <div class="w-16 h-16 rounded-full border-2 border-pink-500 flex items-center justify-center text-xl font-bold text-white bg-pink-500">
            {{ provider.imgText }}
          </div>
          <div>
            <h3 class="text-xl font-bold text-gray-900">{{ provider.name }}</h3>
            <p class="text-gray-600">{{ provider.specialty }}</p>
            <div class="flex items-center mt-1">
              <span class="text-sm font-bold mr-1 text-gray-800">{{ provider.rating.toFixed(1) }}</span>
              <span [innerHTML]="generateRatingStars(provider.rating)"></span>
              <span class="text-sm text-gray-500 ml-2">({{ provider.reviews }} Avis)</span>
            </div>
          </div>
        </div>

        <div class="flex flex-col items-start md:items-end space-y-2">
          <div [ngClass]="provider.statusClass"
               class="availability-status flex items-center font-semibold px-3 py-1 rounded-full text-sm">
            <span *ngIf="provider.status === 'Disponible'" class="relative flex h-2 w-2 mr-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-pink-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-pink-500"></span>
            </span>
            {{ provider.status }}
          </div>

          <p class="text-2xl font-bold text-pink-600">À partir de {{ provider.rate }}€</p>

          <button (click)="handleBookProvider(provider.id)"
                  [disabled]="provider.status !== 'Disponible'"
                  [ngClass]="{
                    'bg-pink-600 hover:bg-pink-700': provider.status === 'Disponible',
                    'bg-gray-400 cursor-not-allowed': provider.status !== 'Disponible'
                  }"
                  class="px-5 py-2 text-white font-semibold rounded-lg transition duration-300">
            {{ provider.btnText }}
          </button>
        </div>
      </div>
    </div>
  </section>

  <section *ngIf="appState.step === 'check_availability' && appState.selectedProvider">
    <div class="w-full max-w-lg mx-auto bg-white shadow-xl rounded-xl p-8">
      <h2 class="text-3xl font-bold text-indigo-700 mb-4">
        Réserver avec {{ appState.selectedProvider.name }}
      </h2>
      <p class="text-gray-600 mb-6">{{ appState.selectedProvider.specialty }}</p>

      <div class="space-y-4">
        <div>
          <label for="reservation-time" class="block text-sm font-medium text-gray-700 mb-1">Date et Heure Souhaitées</label>
          <input type="datetime-local" id="reservation-time" #timeInput
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
        </div>

        <button (click)="handleAvailabilityCheck(timeInput.value)"
                class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">
          Vérifier la Disponibilité
        </button>
        <button (click)="changeStep('list')"
                class="w-full text-gray-600 border border-gray-300 py-2 rounded-xl font-medium hover:bg-gray-50 transition duration-200">
          Annuler et Retour à la liste
        </button>
      </div>
    </div>
  </section>

  <section *ngIf="appState.step === 'select_payment' && appState.selectedProvider && appState.reservationDetails">
    <div class="w-full max-w-lg mx-auto bg-white shadow-xl rounded-xl p-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Paiement pour {{ appState.selectedProvider.name }}</h2>
      <div class="bg-indigo-50 p-4 rounded-lg mb-6 shadow-inner">
        <p class="text-gray-700"><strong>Réservation ID:</strong> {{ appState.reservationDetails.id }}</p>
        <p class="text-gray-700"><strong>Heure:</strong> {{ appState.reservationDetails.time | date: 'medium' }}</p>
        <p class="text-gray-700 font-bold mt-2">Montant suggéré : <span class="text-indigo-600">{{ appState.selectedProvider.rate | number: '1.2-2' }} €</span></p>
        <p class="text-sm text-gray-500 mt-1">Vous pourrez modifier ce montant à l'étape suivante.</p>
      </div>

      <h3 class="text-xl font-semibold text-gray-800 mb-4">Choisissez votre mode de paiement</h3>

      <div class="grid grid-cols-3 gap-3">
        <button (click)="selectPaymentMethod('wave')"
                class="bg-purple-600 text-white p-4 rounded-xl font-bold flex flex-col items-center justify-center text-center shadow-lg hover:shadow-xl hover:bg-purple-700 transition">
          <span class="text-2xl mb-1">&#128241;</span>
          <span class="text-sm">Wave</span>
        </button>
        <button (click)="selectPaymentMethod('orange-money')"
                class="bg-orange-500 text-white p-4 rounded-xl font-bold flex flex-col items-center justify-center text-center shadow-lg hover:shadow-xl hover:bg-orange-600 transition">
          <span class="text-2xl mb-1">&#128241;</span>
          <span class="text-sm">Orange Money</span>
        </button>
        <button (click)="selectPaymentMethod('card')"
                class="bg-blue-600 text-white p-4 rounded-xl font-bold flex flex-col items-center justify-center text-center shadow-lg hover:shadow-xl hover:bg-blue-700 transition">
          <span class="text-2xl mb-1">&#127382;</span>
          <span class="text-sm">Carte Bancaire</span>
        </button>
      </div>

      <button (click)="changeStep('check_availability')" class="w-full mt-6 text-indigo-600 border border-indigo-200 py-2 rounded-xl font-medium hover:bg-indigo-50 transition duration-200">
        Retour à la vérification d'heure
      </button>
    </div>
  </section>

  <section *ngIf="appState.step === 'payment_form' && appState.selectedProvider">
    <div class="w-full max-w-lg mx-auto bg-white shadow-xl rounded-xl p-8 transition-all duration-300">

      <h2 class="text-2xl font-bold text-gray-800 mb-4">{{ getFriendlyMethodName(appState.selectedPaymentMethod) }}</h2>
      <p class="text-center text-gray-500 mb-6">Paiement pour <span class="font-semibold text-pink-600">{{ appState.selectedProvider.name }}</span></p>

      <form (ngSubmit)="handlePaymentSubmission()" class="space-y-4">

        <div class="mb-5 p-3 bg-pink-50 rounded-lg border border-pink-200">
          <label for="input-payment-amount" class="block text-sm font-bold text-gray-700 mb-1">Montant à payer (en €) - Saisie Utilisateur</label>
          <input type="number" id="input-payment-amount" placeholder="Entrez le montant" required min="1"
                 [(ngModel)]="paymentFormData.amountEUR" name="amount"
                 class="w-full px-4 py-3 text-lg border-2 border-pink-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 transition duration-150">
          <p class="text-xs text-gray-500 mt-1">Montant suggéré pour cette prestation : {{ appState.selectedProvider.rate | number: '1.2-2' }}€.</p>
        </div>

        <div *ngIf="appState.selectedPaymentMethod === 'wave'" class="space-y-4">
          <label for="wave-phone" class="block text-sm font-medium text-gray-700 mb-1">Numéro de Téléphone Wave (Saisie Utilisateur)</label>
          <input type="tel" id="wave-phone" placeholder="Ex: 77 000 00 00" required
                 [(ngModel)]="paymentFormData.wave_phone" name="wave_phone"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-150">
        </div>

        <div *ngIf="appState.selectedPaymentMethod === 'orange-money'" class="space-y-4">
          <label for="om-phone" class="block text-sm font-medium text-gray-700 mb-1">Numéro de Téléphone OM (Saisie Utilisateur)</label>
          <input type="tel" id="om-phone" placeholder="Ex: 78 000 00 00" required
                 [(ngModel)]="paymentFormData.om_phone" name="om_phone"
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition duration-150">
        </div>

        <div *ngIf="appState.selectedPaymentMethod === 'card'" class="space-y-4">
          <div class="mb-3">
            <label for="card-number" class="block text-sm font-medium text-gray-700 mb-1">Numéro de Carte</label>
            <input type="text" id="card-number" placeholder="XXXX XXXX XXXX XXXX" required maxlength="19"
                   [(ngModel)]="paymentFormData.card_number" name="card_number"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
          </div>

          <div class="grid grid-cols-2 gap-4 mb-3">
            <div>
              <label for="card-expiry" class="block text-sm font-medium text-gray-700 mb-1">Date d'Expiration (MM/AA)</label>
              <input type="text" id="card-expiry" placeholder="MM/AA" required maxlength="5"
                     [(ngModel)]="paymentFormData.card_expiry" name="card_expiry"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            </div>
            <div>
              <label for="card-cvv" class="block text-sm font-medium text-gray-700 mb-1">CVV</label>
              <input type="text" id="card-cvv" placeholder="123" required maxlength="4"
                     [(ngModel)]="paymentFormData.card_cvv" name="card_cvv"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            </div>
          </div>

          <div class="mb-3">
            <label for="card-name" class="block text-sm font-medium text-gray-700 mb-1">Nom sur la Carte</label>
            <input type="text" id="card-name" placeholder="JOHN DOE" required
                   [(ngModel)]="paymentFormData.card_name" name="card_name"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
          </div>
        </div>

        <button type="submit"
                class="w-full bg-pink-600 text-white py-3 rounded-xl font-semibold hover:bg-pink-700 transition duration-200 shadow-lg">
          Confirmer la Réservation et Payer {{ paymentFormData.amountEUR | number: '1.2-2' }} €
        </button>
        <button type="button" (click)="changeStep('select_payment')"
                class="w-full text-gray-600 border border-gray-300 py-2 rounded-xl font-medium hover:bg-gray-50 transition duration-200">
          Retour au choix de la méthode
        </button>
      </form>
    </div>
  </section>

  <section *ngIf="appState.step === 'complete' && appState.selectedProvider && appState.reservationDetails">
    <div class="w-full max-w-lg mx-auto text-center p-8 bg-green-50 rounded-xl border border-green-300 shadow-xl">
      <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h2 class="text-2xl font-bold text-green-700 mb-2">Réservation Confirmée !</h2>
      <p class="text-gray-600 mb-4">Votre rendez-vous avec **{{ appState.selectedProvider.name }}** est validé.</p>

      <div class="bg-white p-4 rounded-lg text-left inline-block shadow-inner">
        <p class="text-sm text-gray-700"><strong>ID:</strong> {{ appState.reservationDetails.id }}</p>
        <p class="text-sm text-gray-700"><strong>Heure:</strong> {{ appState.reservationDetails.time | date: 'medium' }}</p>
        <p class="text-sm text-gray-700"><strong>Montant payé:</strong> {{ appState.reservationDetails.amount | number: '1.2-2' }} XOF</p>
        <p class="text-sm text-gray-700"><strong>Paiement via:</strong> {{ getFriendlyMethodName(appState.selectedPaymentMethod) }}</p>
      </div>

      <button (click)="changeStep('list')"
              class="mt-6 bg-indigo-600 text-white py-2 px-4 rounded-xl font-semibold hover:bg-indigo-700 transition duration-200">
        Retourner à la liste des prestataires
      </button>
    </div>
  </section>

</main>
